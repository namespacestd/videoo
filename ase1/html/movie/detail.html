{% extends "base_generic.html" %}

{% block css %}
    <style>
        .movie_review {
            height: 200px;
            width: 500px;
            border-radius: 20px;
            margin-bottom: 10px;
            padding: 20px;
            border-style: solid;
        }

        .user_review_title {
            font-weight: bold;
        }

        .review_author {
            position: absolute;
            bottom: 0px;
        }
    </style>
{% endblock %}

{% block content %}

    <div class="thumbnail">

        <!-- Thumbnail -->
        <img class="movie-poster" src="{{ movie.poster_path }}" />

        <!-- Ratings stars -->
        <div class="ratings">

            {% if is_authenticated %}
                <div>Your rating:</div>

                <a href="/movie/rate/{{movie_id}}?stars=1">
                    {% if user_rating > 0 %}
                        <img class="star" src="/static/img/glyphicons_049_star.png" />
                    {% else %}
                        <img class="star" src="/static/img/glyphicons_048_dislikes.png" />
                    {% endif %}
                </a>
                <a href="/movie/rate/{{movie_id}}?stars=2">
                    {% if user_rating > 1 %}
                        <img class="star" src="/static/img/glyphicons_049_star.png" />
                    {% else %}
                        <img class="star" src="/static/img/glyphicons_048_dislikes.png" />
                    {% endif %}
                </a>
                <a href="/movie/rate/{{movie_id}}?stars=3">
                    {% if user_rating > 2 %}
                        <img class="star" src="/static/img/glyphicons_049_star.png" />
                    {% else %}
                        <img class="star" src="/static/img/glyphicons_048_dislikes.png" />
                    {% endif %}
                </a>
                <a href="/movie/rate/{{movie_id}}?stars=4">
                    {% if user_rating > 3 %}
                        <img class="star" src="/static/img/glyphicons_049_star.png" />
                    {% else %}
                        <img class="star" src="/static/img/glyphicons_048_dislikes.png" />
                    {% endif %}
                </a>
                <a href="/movie/rate/{{movie_id}}?stars=5">
                    {% if user_rating > 4 %}
                        <img class="star" src="/static/img/glyphicons_049_star.png" />
                    {% else %}
                        <img class="star" src="/static/img/glyphicons_048_dislikes.png" />
                    {% endif %}
                </a><br/><br/>

                <div class = "movie_list_quick_add">
                    <form action="/profile/userlist/quick_add" method="post">
                        {% csrf_token %}                        
                        <select name="movie_status" required>
                            <option value=""></option>
                            <option value="Watching"> Watching </option>
                            <option value="Plan to Watch"> Plan to Watch </option>
                            <option value="Completed"> Completed </otpion>
                        </select>
                        <input style="display:none;" type="text" name="movie_id" value="{{movie_id}}"> </input>
                        <input type="submit" value="Add Movie to List"> </input>
                    </form>
                </div><br/>
            {% endif %}

            <div>Overall user rating: {{ movie.avg_rating }}</div>
        </div>

    </div>

    <!-- Detail pane -->
    <div class="detail">
        <h2>{{ movie.title }}</h2>
        <label>Release Date</label>
        <div>{{ movie.release_date }}</div>
        <label>Overview</label>
        <div>{{ movie.overview }}</div>
        {% load humanize %}
        <label>Budget</label>
        <div>${{ movie.budget|intcomma }}</div>
        <label>Revenue</label>
        <div>${{ movie.revenue|intcomma }}</div>
    </div>

    <div class="content">
        {% for review in all_reviews %}
        <div class="movie_review" style="position: relative;">
            <div class="user_review_rating" {% if is_authenticated and review.is_current_user %}id="user_review_edit"{% endif %} style="float:right;">
                {% if is_authenticated and review.is_current_user %} <div id="edit_review" style="float: left; margin-right: 15px; cursor:pointer;"> Edit </div> {%endif%}{{ review.upvote }} {% if is_authenticated %}<a href="/rating/rate/{{movie_id}}/0?review_of={{review.review.user.user}}"> {%endif%}<img width="25px" src="/static/img/thumbs_up.png"/> {% if is_authenticated %}</a>{%endif%}
                {{ review.downvote }} {% if is_authenticated %}<a href="/rating/rate/{{movie_id}}/1?review_of={{review.review.user.user}}">{%endif%}<img width="25px" src="/static/img/thumbs_down.png"/> {% if is_authenticated %}</a>{%endif%}
            </div>

            <div class="user_review_title" {% if is_authenticated and review.is_current_user %} id="user_review_edit_title" {% endif %}>
                {{ review.review.review_title }}
            </div>
            
            {% if is_authenticated and review.is_current_user %}<div id="user_review_edit_content"> {% endif %}
                {{ review.review.review_body }}            
            {% if is_authenticated and review.is_current_user %}</div>{%endif%}

            <div class="review_author">
                Review Written by {{review.review.user.user}} on {{review.review.date_created}}.
            </div>

        </div>
        {% endfor %}
        {% if is_authenticated %}
            {% if not already_reviewed %}
                <button id="quick_review_button">Add Quick Review</button>
                <div id="quick_review" style="display: none;">
                    <form action="/review/submit_review" method="post">
                        {% csrf_token %} <br/>
                        Title:
                        <input name="review_title" type="text"> </input>
                        <br/><br/>

                        Review Text: <br/>
                        <textarea name="review_body"></textarea>
                        <input name="movie_id" style="display:none;" value="{{movie_id}}" />
                       <input type="submit" value="Submit Review"> </input>
                    </form>
                </div>
            {% endif %}
        {% else %}
            Please login to add reviews.
        {% endif %}

        <!-- Reviews go here -->
    </div>

{% endblock %}

{% block js %}
<script>
    $(window).bind("load", function() {
        var edit_review_url = "/review/edit_review/{{movie_id}}/";

        $('#quick_review_button').click(function() {
            if($('#quick_review').css("display") == "block") {
                $('#quick_review').css("display", "none");
                document.getElementById("quick_review_button").innerHTML="Add Quick Review";
            }
            else {  
                $('#quick_review').css("display", "block");
                document.getElementById("quick_review_button").innerHTML="Hide Quick Review";
                var something;
            }
        });

        $("#edit_review").click(function() {
            current_review = $("#user_review_edit_content").html().trim();
            current_review_title = $("#user_review_edit_title").html().trim();
            $("#user_review_edit").html("<form action=\""+edit_review_url+"\" method=\"post\">{% csrf_token %}<input style=\"position:absolute; top:5px; left: 10px; width: 90%; \" name=\"new_review_title\" type=\"text\" value=\""+current_review_title+"\"></input><textarea name=\"new_review_body\" style=\"width:"+ ($(".movie_review").width()+25) + "px; height: " + ($(".movie_review").height()) + "px; position: absolute; top:30px; left:5px; resize: none;\">" + current_review + "</textarea><input type=\"submit\" value=\"Edit Review\" style=\"position: absolute; left: "+ (($(".movie_review").width())/2 - 25) +"px; bottom: 0px;\"> </input></form><a href=\"/review/delete_review/{{movie_id}}/\"><button style=\"position: absolute; bottom: 0px;\"> Delete Review </button></a>");
        });

        $("#submit_edit").click(function() {
            alert("Edited review");
        });
    });
</script>
{% endblock %}